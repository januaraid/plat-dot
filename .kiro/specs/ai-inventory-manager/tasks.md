# 実装計画

## 進捗状況
- 作成日: 2025-07-21
- 最終更新: 2025-08-03
- ステータス: フェーズ7タスク18完了（AI機能基盤準備）
- 総タスク数: 31（タスク20.5を20に統合）
- 完了: 18
- 残り: 13

---

## フェーズ1: プロジェクト基盤とセットアップ

- [x] 1. プロジェクト基盤構築
  - Next.js 14.x (App Router) + TypeScript プロジェクト初期化
  - Tailwind CSS, ESLint, Prettier の設定
  - package.json 依存関係設定（prisma, next-auth, zod）
  - 基本的なディレクトリ構造作成（src/app/, src/components/, src/lib/）
  - _要件: 9.1, 9.2_

- [x] 2. データベース設計と初期設定
  - Prismaスキーマ設計（User, Item, Folder, ItemImage, PriceHistory モデル）
  - SQLite開発環境とPostgreSQL本番環境の設定
  - 初期マイグレーション実行とシードデータ作成
  - データベース接続テスト
  - _要件: 8.1, 10.1_

## フェーズ2: 認証システムとセキュリティ

- [x] 3. NextAuth.js認証システム構築
  - ✅ NextAuth.js v5 (Auth.js) + ハイブリッド方式（JWT + 手動DB保存）の設定
  - ✅ Google OAuth認証プロバイダー設定
  - ✅ セッション管理とJWTトークン設定
  - ✅ 認証ミドルウェア実装
  - ✅ ユーザー情報のデータベース保存・取得機能
  - ✅ 認証フロー完全動作確認済み
  - _要件: 8.1, 8.2, 8.6_

- [x] 4. セキュリティ機能実装
  - ✅ HTTPS強制とCSRF対策設定
  - ✅ 入力検証用Zodスキーマ定義（item, folder, user, uploadの各バリデーション実装）
  - ✅ レート制限ミドルウェア実装（メモリベース、API別設定対応）
  - ✅ セキュリティヘッダー設定（CSP, HSTS, X-Frame-Options等）
  - _要件: 10.2, 10.5, 10.6_

## フェーズ3: 基本アイテム管理CRUD

- [x] 5. アイテム管理API実装
  - ✅ GET /api/items（一覧取得）の実装
  - ✅ POST /api/items（新規作成）の実装
  - ✅ PUT /api/items/[id]（更新）の実装
  - ✅ DELETE /api/items/[id]（削除）の実装
  - ✅ Zodバリデーションとエラーハンドリング
  - ✅ ページネーション、ソート、フィルタリング機能
  - ✅ ユーザーID不整合問題修正（認証システム改善）
  - _要件: 1.1, 1.2, 1.4, 1.5_

- [x] 6. アイテム検索・フィルタリング機能
  - ✅ 検索クエリパラメータ処理（名前、カテゴリ、説明での部分一致）
  - ✅ Prismaクエリ最適化とインデックス設計
  - ✅ ページネーション機能実装
  - ✅ ソート機能実装（作成日、更新日、名前順）
  - ✅ 詳細検索テストUI実装
  - _要件: 1.3_

- [x] 7. バリデーションとエラーハンドリング
  - ✅ アイテム作成・更新時のZodバリデーション拡張（文字列正規化、日付・価格検証、ビジネスルール）
  - ✅ 必須項目チェックとエラーメッセージ改善（日本語対応、詳細なエラー説明）
  - ✅ APIエラーレスポンス統一化（ErrorResponses、handleDatabaseError、型安全なエラー）
  - ✅ クライアントサイドエラー表示実装（リアルタイムバリデーション、フィールド別エラー表示）
  - ✅ バリデーションテストUI（/test/items/validation）完備
  - _要件: 1.6_

## フェーズ4: フォルダ分類システム

- [x] 8. フォルダ管理API実装
  - ✅ POST /api/folders（フォルダ作成）の実装（階層深度制限、重複名チェック）
  - ✅ GET /api/folders（フォルダ一覧）の実装（親フォルダフィルタ、アイテム数・子フォルダ数カウント）
  - ✅ PUT /api/folders/[id]（フォルダ更新）の実装（循環参照チェック、階層制限）
  - ✅ DELETE /api/folders/[id]（フォルダ削除、アイテム未分類移動処理）の実装
  - ✅ フォルダバリデーションスキーマ強化（予約語チェック、文字制限、ID形式対応）
  - _要件: 2.1, 2.4_

- [x] 9. フォルダ階層機能実装
  - ✅ 3階層までのネストフォルダ作成機能（作成・更新時の深度チェック）
  - ✅ 階層構造の表示とナビゲーション（ツリービューAPI、統計情報、パンくずナビ）
  - ✅ フォルダ移動時の循環参照チェック（子孫チェック、自己参照防止）
  - ✅ 階層深度制限のバリデーション（移動時深度計算、3階層制限）
  - ✅ フォルダ移動API（/api/folders/move）実装
  - ✅ フォルダツリーAPI（/api/folders/tree）実装
  - ✅ 階層テストUI（/test/folders/tree）実装
  - _要件: 2.5_

- [x] 10. アイテム・フォルダ関連機能
  - ✅ アイテムのフォルダ移動機能（POST /api/items/move、ドラッグ&ドロップ対応準備）
  - ✅ フォルダ内アイテム一覧表示（GET /api/folders/[id]/items、検索・ページネーション対応）
  - ✅ フォルダ名重複チェック機能（フォルダ作成・更新時の同階層チェック実装済み）
  - ✅ 未分類アイテム管理（GET /api/items/uncategorized、統計情報付き）
  - ✅ 包括的なテストUI（/test/items/folders）実装
  - _要件: 2.2, 2.3, 2.6_

## フェーズ5: 画像管理システム

- [x] 11. ファイルアップロード基盤
  - ✅ POST /api/upload エンドポイント実装（multipart/form-data対応）
  - ✅ ファイル形式検証（JPG、PNG、WEBP）MIMEタイプと拡張子の両方をチェック
  - ✅ ファイルサイズ制限（10MB）チェック（クライアント・サーバー両側）
  - ✅ ローカルファイルストレージ（uploads/フォルダ）設定
  - ✅ GET /api/upload アップロード設定情報取得API実装
  - ✅ GET /api/uploads/[...path] 画像提供API実装（セキュリティ対策付き）
  - ✅ Prismaスキーマとの整合性確保（filename, size フィールド）
  - ✅ 包括的なテストUI（/test/upload）実装
  - _要件: 3.1, 3.6_

- [x] 12. 画像管理機能実装
  - ✅ ItemImageモデルとの連携実装（GET /api/items/[id]/images）
  - ✅ 1アイテムあたり最大10枚の画像制限（アップロード時チェック、残り枠表示）
  - ✅ 画像の順序変更機能（PUT /api/images/order、2段階更新でユニーク制約違反回避）
  - ✅ 画像削除機能と確認ダイアログ（DELETE /api/images/[id]、ファイル・DB両方削除）
  - ✅ 包括的なテストUI（/test/images）実装（順序変更、削除、統計情報）
  - ✅ ドラッグ&ドロップ対応準備（現在はドロップダウン、将来拡張可能）
  - _要件: 3.2, 3.4, 3.5_

- [x] 13. 画像表示最適化
  - ✅ サムネイル生成機能（Sharp使用）
  - ✅ 遅延読み込み（Lazy Loading）実装
  - ✅ フルサイズ画像モーダル表示
  - ✅ レスポンシブ画像表示
  - ✅ 包括的なテストUI（/test/optimized-images）実装
  - _要件: 3.3, 9.4_

## フェーズ6: フロントエンドUI実装

- [x] 14. 基本レイアウトとナビゲーション
  - ✅ src/app/layout.tsx メインレイアウト作成
  - ✅ ヘッダー、サイドバー、フッターコンポーネント
  - ✅ レスポンシブナビゲーションメニュー
  - ✅ ログイン/ログアウトUI
  - ✅ セッション判定ロジック修正（全コンポーネント）
  - ✅ ヘッダー検索バー削除（機能重複解消）
  - ✅ favicon・ブランディング統一
  - ✅ Google ユーザーアバター表示対応
  - _要件: 9.1, 9.2_

- [x] 15. アイテム一覧・詳細表示UI
  - ✅ アイテムカードコンポーネント作成（グリッド・リスト対応）
  - ✅ グリッドレイアウト（1列・2列・3列・4列対応）
  - ✅ アイテム詳細モーダル（画像ギャラリー付き）
  - ✅ 検索バーとフィルター UI（デバウンス検索）
  - ✅ ページネーション機能
  - ✅ 表示モード・ソート設定の永続化（localStorage）
  - ✅ アップロード画像表示対応（UploadedImageコンポーネント）
  - ✅ Next.js画像最適化設定・エラー修正
  - ✅ アイテム一覧ページ(/items)実装
  - ✅ トップページ機能タイルのリンク化
  - _要件: 1.2, 1.3_

- [x] 16. 統合フォルダ管理機能
  - ✅ サイドバーにフォルダツリー表示追加（FolderTreeコンポーネント実装）
  - ✅ フォルダ作成・編集・削除機能（FolderModalコンポーネント統合）
  - ✅ フォルダクリックによる自動フィルタリング（selectedFolderId連携）
  - ✅ アイテムのフォルダ間移動（ドラッグ&ドロップ対応）
  - ✅ パンくずナビゲーション（Breadcrumbコンポーネント）
  - ✅ 3階層制限UI実装（4階層目作成ボタン非表示）
  - ✅ サイドバーリサイズ機能（ドラッグリサイズ、LocalStorage永続化）
  - ✅ サイドバー最小化機能（アイコンのみ表示モード）
  - ✅ モバイルレスポンシブ対応（フィルター表示最適化）
  - ✅ フォルダ操作後の自動リフレッシュ（イベント駆動）
  - ✅ 認証状態チェック（未ログイン時のAPI呼び出し防止）
  - ✅ トップページランディング化（サイドバー非表示、シンプル化）
  - ✅ ナビゲーション順序最適化（アイテム管理を最上位に）
  - _要件: 2.1, 2.3, 2.5_

- [x] 17. ダッシュボード画面実装
  - ✅ ダッシュボードページ(/dashboard)作成
  - ✅ アイテム統計情報表示（総数、カテゴリ別分布）
  - ✅ フォルダ統計情報表示（フォルダ数、階層別分布）
  - ✅ 最近追加したアイテム一覧（5件程度）
  - ✅ 最近更新したアイテム一覧（5件程度）
  - ✅ クイックアクションボタン（新規アイテム作成等）
  - ✅ レスポンシブデザイン対応
  - ✅ ローディング状態とエラーハンドリング
  - ✅ GET /api/dashboard/stats エンドポイント実装
  - _要件: 9.1, 9.2_

- [x] 18. アイテム作成・編集フォーム
  - ✅ アイテム作成フォームコンポーネント
  - ✅ アイテム編集フォームコンポーネント
  - ✅ フォルダ選択UI（統合フォルダ管理と連携）
  - ✅ 画像アップロード・プレビュー機能
  - ✅ 画像管理ページ（アップロード・削除・並び替え）
  - ✅ リアルタイムバリデーション表示
  - ✅ フォーム送信時のローディング状態
  - ✅ フォーム入力値の永続化（LocalStorage）
  - ✅ アイテム詳細表示（個別ページ化）
  - ✅ レスポンシブデザイン対応
  - ✅ エラーハンドリング・フォーカス管理
  - _要件: 1.1, 1.4, 1.6_

## フェーズ7: AI機能基盤

- [x] 18. AI機能API基盤準備
  - ✅ Google Generative AI SDK（@google/genai）のインストール（package.jsonに追加済み）
  - ✅ Gemini 2.5 Flash-Lite モデルの使用設定（gemini.ts実装済み）
  - ✅ GEMINI_API_KEY 環境変数設定（.env.localに設定済み）
  - ✅ POST /api/ai/recognize エンドポイント実装完了
  - ✅ レート制限（15 RPM）の実装（checkRateLimit関数実装済み）
  - ✅ エラーハンドリング（API制限、ネットワークエラー）実装済み
  - ✅ 動作確認テスト（API キー接続確認）実装済み
  - ✅ **AiUsageLogテーブル**による使用履歴管理システム実装
  - ✅ GET /api/ai/usage エンドポイント（機能別使用統計）実装
  - ✅ GET /api/ai/test エンドポイント（接続テスト）実装
  - ✅ AIテストページ（/test/ai）での動作確認完了
  - ✅ 画像アップロード・認識機能の動作確認完了
  - _要件: 4.1, 7.1_

- [ ] 19. AI商品名認識UI実装
  - 画像アップロード時のAI認識トリガー（Gemini 2.5 Flash-Lite使用）
  - AI認識結果の表示UI（商品名3候補、カテゴリ、メーカー）
  - 認識結果の自動入力機能（商品名、カテゴリ、メーカーフィールド）
  - 商品名提案の採用・拒否機能
  - _要件: 4.2, 4.4, 4.5, 4.6_

- [ ] 20. AI価格調査機能＋価格履歴システム実装
  - ✅ PriceHistoryDetailモデルの追加（詳細価格情報）
  - ✅ 既存PriceHistoryモデルの拡張（summaryフィールド等）
  - データベースマイグレーション実行
  - ✅ Google検索グラウンディング機能を活用した価格検索（searchItemPrices実装済み）
  - POST /api/ai/search-prices エンドポイント実装（履歴保存機能付き）
  - GET /api/items/[id]/price-history エンドポイント実装
  - ✅ 価格履歴保存・取得関数の実装（savePriceHistory, getPriceHistory実装済み）
  - 価格検索結果表示UI（複数サイトの価格比較）
  - 価格相場サマリー表示
  - フリマサイトリンク表示
  - 価格履歴自動保存機能
  - _要件: 5.1, 5.2, 5.3, 5.5_
  - **次の実装ステップ**: データベースマイグレーション実行 → API エンドポイント作成

## フェーズ8: 拡張ダッシュボード機能

- [ ] 21. AI価格推移ダッシュボード
  - GET /api/dashboard/price-trends エンドポイント実装
  - GET /api/dashboard/value-summary エンドポイント実装
  - 持ち物総額表示（現在価格ベース）
  - アイテム別価格推移チャート（Chart.js使用）
  - カテゴリ別価格分布グラフ
  - 最も価値の高いアイテムランキング
  - 価格上昇・下降トレンド表示
  - 価格履歴データの可視化（min/avg/max価格）
  - _要件: AI価格比較機能連携_

- [ ] 22. 詳細統計ダッシュボード
  - 月別購入金額推移
  - カテゴリ別アイテム数・金額比較
  - フォルダ別資産価値分析
  - 購入履歴統計（購入頻度、平均単価等）
  - 損益計算（購入価格 vs 現在価格）
  - _要件: 分析・レポート機能_

- [ ] 23. インタラクティブ分析機能
  - 期間指定での統計表示
  - カテゴリ・フォルダでのフィルタリング分析
  - データエクスポート（CSV、PDF形式）
  - グラフの拡大・詳細表示
  - 比較分析機能（期間比較、カテゴリ比較）
  - _要件: データビジュアライゼーション_

## フェーズ9: ユーザー管理機能

- [ ] 24. ユーザープロフィール管理
  - ユーザープロフィール表示・編集ページ
  - パスワードリセット機能
  - アカウント削除機能（確認手続き付き）
  - メール認証機能
  - _要件: 8.3, 8.5_

- [ ] 25. データエクスポート機能
  - ユーザーデータのCSVエクスポート機能
  - アイテム・フォルダ・画像データの一括出力
  - エクスポートファイル生成とダウンロード
  - プライバシー保護（画像URLの処理）
  - _要件: 8.4_

- [ ] 26. フリーミアム機能制限実装
  - AI機能利用回数制限チェック
  - 利用状況ダッシュボード表示
  - 有料プランアップグレードUI
  - 制限超過時のメッセージ表示
  - _要件: 7.1, 7.2, 7.4_

## フェーズ10: パフォーマンス・最適化

- [ ] 27. フロントエンド最適化
  - React.memoとuseMemoによる再レンダリング最適化
  - 仮想スクロール実装（大量アイテム対応）
  - 画像の遅延読み込みとプリロード
  - コードスプリッティングとChunk最適化
  - _要件: 9.3, 9.4_

- [ ] 28. オフライン対応とPWA機能
  - Service Worker実装
  - オフライン時の基本閲覧機能
  - キャッシュ戦略実装
  - ネットワーク状態表示とエラーハンドリング
  - _要件: 9.5, 9.6_

- [ ] 29. データベース最適化
  - 適切なインデックス設計と作成
  - N+1クエリ問題の解決
  - データベース接続プーリング設定
  - 不要データのクリーンアップスクリプト
  - _要件: 9.3, 10.1_

## フェーズ11: テスト・品質保証

- [ ] 30. ユニットテスト実装
  - API エンドポイントのテスト（Jest + Supertest）
  - Reactコンポーネントのテスト（Testing Library）
  - ビジネスロジックの単体テスト
  - バリデーション機能のテスト
  - _要件: 全要件のテストカバレッジ_

- [ ] 31. 統合・E2Eテスト
  - 主要ユーザーフローのE2Eテスト（Playwright）
  - データベース統合テスト
  - 認証フローのテスト
  - ファイルアップロード機能のテスト
  - _要件: 全要件の統合テスト_

- [ ] 32. デプロイメント・本番環境設定
  - Vercel本番環境設定
  - 環境変数とシークレット管理
  - PostgreSQL本番データベース設定
  - モニタリングとログ設定
  - _要件: 10.2, 10.5_

---

## 実装メモ・学んだこと

### フェーズ2: 認証システムとセキュリティで学んだこと

#### NextAuth.js認証システム構築での学び
- **NextAuth.js v5 (Auth.js) 移行の課題**: v4からv5への移行時、Prisma Adapterとの互換性問題が発生
- **解決策**: ハイブリッド方式を採用（JWT戦略 + signInコールバックでの手動DB保存）
- **環境変数**: v5では`AUTH_SECRET`が必要、`NEXTAUTH_*`は不要
- **ミドルウェア**: v5では`auth()`関数をラップする形式に変更
- **安定性**: Prisma Adapterを使用せず、手動でユーザー情報をDB保存する方が安定
- **セッション管理**: JWT戦略でも十分、データベース戦略は設定が複雑

#### セキュリティ機能実装での学び
- **セキュリティヘッダー**: CSP（Content Security Policy）の設定でGoogle OAuth用のドメインを許可する必要がある
- **レート制限**: メモリベースの実装は開発には十分だが、本番環境ではRedis推奨
- **Zodバリデーション**: 再利用可能なスキーマとエラーハンドリングユーティリティで開発効率向上
- **型安全性**: ZodスキーマからTypeScript型を自動生成することで型の一貫性を保持

### フェーズ3: 基本アイテム管理CRUDで学んだこと

#### アイテム管理API実装での学び
- **Edge Runtime問題**: PrismaクライアントはEdge Runtimeで動作しないため、`export const runtime = 'nodejs'`が必要
- **ユーザーID不整合問題**: NextAuth.jsのデフォルト設定では再ログイン時にユーザーIDが変わる問題が発生
- **解決策**: メールアドレスをベースにした一貫性のあるユーザーID管理を実装
- **データベースリセット**: 認証システム変更時は既存データとの互換性確保のためDBリセットが必要
- **認証チェック**: APIルートでは`session.user.email`を確認し、`ensureUserExists`でユーザー存在を保証

#### アイテム検索・フィルタリング機能実装での学び
- **SQLite制限事項**: `mode: "insensitive"`はPostgreSQL専用でSQLiteでは使用不可
- **SQLite検索対応**: 検索クエリをlowerCase()で正規化してContains検索を実行
- **インデックス最適化**: ユーザーID、名前、カテゴリ等の複合インデックスで検索パフォーマンス向上
- **検索テストUI**: 詳細検索機能のテスト用UIを`/test/items/search`に実装

#### バリデーションとエラーハンドリング実装での学び
- **Zodカスタムバリデーション**: 文字列正規化（trim）、日付・価格の厳密検証、ビジネスルール検証を統合
- **エラーメッセージ国際化**: 日本語エラーメッセージとフィールド名のカスタマイズで利用者体験向上
- **型安全なエラーハンドリング**: ErrorType enum、DetailedError interface、ErrorResponsesヘルパーで統一化
- **Prismaエラー処理**: データベース固有エラーコード（P2002、P2025等）の適切なハンドリング
- **クライアントサイドUX**: リアルタイムバリデーション、フィールド別エラー表示、テストシナリオUIで開発効率向上

### フェーズ4: フォルダ分類システムで学んだこと

#### フォルダ管理API実装での学び
- **階層深度制限**: 再帰的な親フォルダチェックで3階層制限を実装
- **重複名チェック**: 同階層での重複名をPrismaクエリで効率的にチェック
- **カスケード処理**: フォルダ削除時のアイテム未分類移動処理の実装
- **統計情報**: _countを使用したアイテム数・子フォルダ数の効率的な取得
- **予約語チェック**: Windows/macOS/Linux環境での互換性確保

#### フォルダ階層機能実装での学び
- **再帰CTE（Common Table Expression）**: SQLiteでの階層構造クエリ実装
- **BigInt型変換**: SQLiteのCOUNT()関数がBigIntを返す問題への対処
- **循環参照チェック**: 子孫チェックアルゴリズムによる安全な階層管理
- **ツリー構造構築**: 再帰的なPromise.allで効率的なツリー構築
- **統計情報収集**: $queryRawでの複雑なSQL実行と結果の型安全な処理

#### アイテム・フォルダ関連機能実装での学び
- **RESTfulなAPI設計**: `/api/items/move`、`/api/folders/[id]/items`などの直感的なエンドポイント
- **フォルダ内アイテム検索**: 既存の検索機能を拡張してフォルダスコープ検索を実装
- **未分類管理**: `folderId: null`を活用した未分類アイテムの効率的な管理
- **統計情報API**: groupByを使用したカテゴリ別分布の集計
- **包括的テストUI**: ドラッグ&ドロップ対応準備を含む統合テスト環境の構築

### フェーズ5: 画像管理システムで学んだこと

#### ファイルアップロード基盤実装での学び
- **Next.js App Routerでのファイルアップロード**: FormDataとFile APIを使用したmultipart/form-data処理
- **Prismaスキーマとの整合性**: スキーマのフィールド名（filename, size）と一致させることの重要性
- **セキュアなファイル名生成**: タイムスタンプ+ランダム文字列でファイル名の衝突を防止
- **パストラバーサル攻撃対策**: ファイル名に`..`や`~`が含まれないかチェック
- **静的ファイル配信**: App Routerの動的ルート`[...path]`を使用した画像提供API
- **包括的なバリデーション**: MIMEタイプと拡張子の両方をチェックすることでセキュリティを強化
- **エラーハンドリング**: ファイルシステムエラー（EACCES、ENOSPC）の適切な処理
- **レスポンスの互換性**: データベースのスネークケースとクライアントのキャメルケースの両方に対応

#### 画像管理機能実装での学び
- **ユニーク制約回避の2段階更新**: `itemId`と`order`の複合ユニーク制約がある場合の安全な順序更新手法
- **トランザクションによる整合性保証**: 複数のUPDATE操作を単一トランザクションで実行
- **ファイルとデータベースの同期削除**: 画像削除時の物理ファイルとDB記録の両方を確実に削除
- **順序の自動再調整**: 削除後の画像順序を0から振り直すロジック
- **所有権チェックの階層化**: アイテム → 画像の階層での権限確認
- **統計情報の提供**: 画像数、総容量、残り枠などのユーザビリティ向上
- **段階的な順序変更UI**: ドロップダウンでの順序変更から将来のドラッグ&ドロップへの拡張性

### フェーズ6: フロントエンドUI実装で学んだこと

#### 統合フォルダ管理機能実装での学び
- **コンポーネント統合戦略**: 既存のFolderTreeとFolderModalを最小限の変更でサイドバーに統合
- **状態管理パターン**: Context + useImperativeHandle での親子間通信とrefresh制御
- **イベント駆動アーキテクチャ**: window.dispatchEvent を使用したコンポーネント間の疎結合通信
- **認証状態対応**: useSession + useRouter による適切なリダイレクトとAPI呼び出し制御
- **ユーザビリティ最適化**: ドラッグリサイズ、最小化、3階層制限UI など細部への配慮
- **レスポンシブデザイン**: デスクトップとモバイルでの UI差分管理（hidden sm:flex パターン）
- **パフォーマンス**: useCallback による無限ループ防止と適切な依存配列管理
- **LocalStorage活用**: UI設定（サイドバー幅、最小化状態）の永続化
- **マウスイベント処理**: ドラッグリサイズでの MouseEvent 処理と z-index 管理
- **シンプル化原則**: 不要な画像管理・フォルダ管理リンクの削除でUI統一

#### ダッシュボード画面実装での学び
- **統計API設計**: 複数の統計情報を一つのエンドポイントで効率的に取得する設計
- **再帰CTE活用**: フォルダ階層統計での WITH RECURSIVE 構文の活用
- **レスポンシブグリッド**: grid-cols-1 md:grid-cols-2 lg:grid-cols-4 による段階的レイアウト
- **動的Tailwindクラス対策**: 色指定の動的クラスを静的マッピング方式に変更
- **統計カードパターン**: アイコン+数値+ラベルの再利用可能なコンポーネント設計
- **条件付きUI表示**: 未分類アイテム存在時のみ表示するクイックアクション
- **型安全な統計データ**: APIレスポンスとフロントエンドでの厳密な型定義
- **エラーハンドリングUX**: 再試行ボタン付きのユーザーフレンドリーなエラー表示
- **useEffect最適化**: sessionオブジェクト参照変更による無限ループ対策
- **ブランディング統一**: ヘッダー・サイドバー・フッターでのロゴアイコン統一

## 次回実装開始に向けての伝達事項（2025-07-24時点）

### 現在の実装状況
- **完了**: フェーズ3タスク5「アイテム管理API実装」まで完了
- **次のタスク**: フェーズ3タスク6「アイテム検索・フィルタリング機能」
- **動作確認済み**: CRUD API全機能、認証システム、セキュリティ機能

### 実装済みの主要コンポーネント

#### 認証・セキュリティ基盤
- `src/lib/auth.ts`: NextAuth.js v5設定（メールベースユーザーID管理）
- `src/lib/security.ts`: セキュリティヘッダー、HTTPS強制
- `src/lib/rate-limit.ts`: レート制限（メモリベース）
- `src/lib/user-helper.ts`: ユーザー存在確認・作成ヘルパー

#### API実装
- `src/app/api/items/route.ts`: アイテム一覧取得・作成
- `src/app/api/items/[id]/route.ts`: アイテム詳細・更新・削除
- `src/app/api/test/`: デバッグ用APIエンドポイント

#### バリデーション
- `src/lib/validations/`: Zodスキーマ（item, user, folder, upload）
- 統一されたエラーレスポンス形式

#### テスト環境
- `src/app/test/items/`: アイテム管理テストUI
- `src/app/debug/`: システムデバッグページ
- ホームページからのナビゲーションリンク

### 次回実装時の注意点

#### 技術的な重要事項
1. **Runtime設定**: 全APIルートで`export const runtime = 'nodejs'`が必要
2. **認証パターン**: `ensureUserExists`を使用してユーザー存在を保証
3. **Decimal型**: Prismaの価格フィールドは`decimal.js`ライブラリを使用
4. **データベース**: 既存データとの互換性を維持（リセットしない）

#### 実装方針
1. **既存パターンを踏襲**: 認証チェック、エラーハンドリング、バリデーションパターンを統一
2. **テスト駆動**: 実装後は必ずテストUIでの動作確認を実施
3. **ログ記録**: 重要な処理では適切なコンソールログを出力
4. **型安全性**: ZodスキーマとTypeScript型の一貫性を保持

#### 推奨する実装順序（フェーズ3続き）
1. **タスク6**: アイテム検索・フィルタリング機能
   - 既存のGET /api/itemsに実装済みの検索機能を活用
   - Prismaクエリ最適化とインデックス設計
   
2. **タスク7**: バリデーションとエラーハンドリング
   - 既存のZodバリデーションを拡張
   - フロントエンド側のエラー表示改善

### フェーズ7: AI機能基盤で学んだこと

#### AI機能API基盤準備（タスク18）での学び
- **Google GenAI SDK移行**: Vertex AIからGoogle GenAI SDKに変更、設定が大幅簡素化
- **モデル選択**: Gemini 2.5 Flash-Liteが最もコストパフォーマンスが良い
- **SDK構文変更**: `ai.getGenerativeModel()` → `ai.models.generateContent()` に変更
- **初期化方法**: 明示的APIキー渡し `new GoogleGenAI({ apiKey })` が安定
- **使用履歴管理**: AiUsageLogテーブルによる機能別使用回数管理が効果的
- **エラーハンドリング**: SDK更新時の構文変更に注意、開発サーバー再起動が必要
- **画面更新問題**: React.memo + useCallback + 認証状態安定化パターンが重要
- **レート制限**: 15 RPM制限をメモリベースで実装、実用的

#### ページ更新問題と対処法（2025-08-03追加）
- **問題**: フォーム入力画面でタブ切り替えやフォーカス変更時に画面が自動更新され、入力内容が失われる
- **対処法**: React.memo + useCallback + 認証状態安定化パターンの統一
  - `React.memo(function ComponentName() {})` でコンポーネントをラップ
  - `useRef + useMemo` で認証状態を安定化（一度認証されたらloadingへの変化を無視）
  - `useCallback` で関数の安定化
- **適用対象**: フォーム・入力系ページ（/items/new, /items/[id]/edit, /items/[id]/images）
- **対象外**: 一覧表示ページ（データ鮮度のため更新を維持）

### 環境・設定情報
- **データベース**: SQLite（`/home/ryauchi/work/repository/plat-dot/prisma/dev.db`）
- **認証プロバイダー**: Google OAuth（環境変数設定済み）
- **ポート**: 3000（開発サーバー）
- **Git**: mainブランチで作業中

### トラブルシューティング
- ユーザーID問題が再発した場合: `src/lib/auth.ts`の設定確認
- Edge Runtimeエラー: APIルートに`runtime = 'nodejs'`追加
- 認証エラー: `ensureUserExists`ヘルパーの使用確認

---

## タスク実装ガイドライン

### 完了条件
- 各タスクは2-4時間で完了可能なサイズに設計
- 実装完了後は該当する要件の受入条件をすべて満たす
- ユニットテストまたは手動テストで動作確認済み
- コードレビューとドキュメント更新完了

### 依存関係
- フェーズ1-2は並行実行可能
- フェーズ3はフェーズ1-2完了後
- フェーズ4-6は並行実行可能（フェーズ3完了後）
- フェーズ7は独立実装可能（モック使用）
- フェーズ8-10は他フェーズ完了後

### 技術スタック確認
- Next.js 14.x App Router使用
- TypeScript厳密モード有効
- Prisma ORM + SQLite（開発）/ PostgreSQL（本番）
- NextAuth.js + Google OAuth
- Tailwind CSS + shadcn/ui（将来）

---

## 画面更新・再描画ガイドライン

### 基本方針
ページの性質に応じて、フォーカス時の画面更新動作を使い分ける。

### 再描画を防ぐべきページ（React.memo + useCallback + 認証状態安定化）
**対象**: ユーザーの作業状態を保持すべきページ

#### 実装パターン
```typescript
const PageComponent = memo(function PageComponent() {
  // 認証状態安定化
  const authStateRef = useRef({ isAuthenticated: false, hasBeenAuthenticated: false })
  
  const isAuthenticated = useMemo(() => {
    const currentAuth = status === 'authenticated' && session?.hasSession
    if (currentAuth) {
      authStateRef.current.hasBeenAuthenticated = true
    }
    // 一度認証されていて、現在loadingの場合は認証済みとして扱う
    if (authStateRef.current.hasBeenAuthenticated && status === 'loading') {
      return true
    }
    return currentAuth
  }, [status, session?.hasSession])

  // すべてのハンドラーをuseCallbackでメモ化
  const handleSomething = useCallback(() => {
    // 処理
  }, [dependencies])
})
```

#### 適用済みページ
- `/items/[id]/images` - 画像アップロード・管理画面
- `/test/ai` - AIテスト画面

#### 今後適用検討ページ
- `/items/new` - アイテム新規作成フォーム
- `/items/[id]/edit` - アイテム編集フォーム
- 長時間の入力作業を伴うページ

### 再描画を維持すべきページ（現在の仕様を継続）
**対象**: 最新データの表示が重要なページ

#### 維持理由
- データ鮮度の重要性（在庫管理の性質上）
- 他ユーザーとの同期
- リアルタイム性の確保

#### 対象ページ
- `/items` - アイテム一覧画面
- `/` - ダッシュボード画面  
- `/items/[id]` - アイテム詳細画面
- 各種一覧・詳細表示ページ

### 実装時の注意点
1. **ユーザーフィードバック優先**: 問題報告があった画面から対応
2. **部分的最適化**: 全画面一括対応は避け、必要な画面のみ個別対応
3. **パフォーマンス配慮**: memo化により不要な再レンダリングを防止
4. **テスト確認**: 
   - 他タブに移動→戻る際の動作確認
   - ファイル選択などのインタラクション確認
   - 認証状態の適切な処理確認

### 参考実装
詳細な実装例は以下ファイルを参照：
- `/src/app/items/[id]/images/page.tsx` - 完全実装例
- `/src/app/test/ai/page.tsx` - 適用例
- Zod バリデーション