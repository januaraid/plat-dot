# 実装計画

## 進捗状況
- 作成日: 2025-07-21
- 最終更新: 2025-07-27
- ステータス: フェーズ3タスク6完了
- 総タスク数: 29
- 完了: 6
- 残り: 23

---

## フェーズ1: プロジェクト基盤とセットアップ

- [x] 1. プロジェクト基盤構築
  - Next.js 14.x (App Router) + TypeScript プロジェクト初期化
  - Tailwind CSS, ESLint, Prettier の設定
  - package.json 依存関係設定（prisma, next-auth, zod）
  - 基本的なディレクトリ構造作成（src/app/, src/components/, src/lib/）
  - _要件: 9.1, 9.2_

- [x] 2. データベース設計と初期設定
  - Prismaスキーマ設計（User, Item, Folder, ItemImage, PriceHistory モデル）
  - SQLite開発環境とPostgreSQL本番環境の設定
  - 初期マイグレーション実行とシードデータ作成
  - データベース接続テスト
  - _要件: 8.1, 10.1_

## フェーズ2: 認証システムとセキュリティ

- [x] 3. NextAuth.js認証システム構築
  - ✅ NextAuth.js v5 (Auth.js) + ハイブリッド方式（JWT + 手動DB保存）の設定
  - ✅ Google OAuth認証プロバイダー設定
  - ✅ セッション管理とJWTトークン設定
  - ✅ 認証ミドルウェア実装
  - ✅ ユーザー情報のデータベース保存・取得機能
  - ✅ 認証フロー完全動作確認済み
  - _要件: 8.1, 8.2, 8.6_

- [x] 4. セキュリティ機能実装
  - ✅ HTTPS強制とCSRF対策設定
  - ✅ 入力検証用Zodスキーマ定義（item, folder, user, uploadの各バリデーション実装）
  - ✅ レート制限ミドルウェア実装（メモリベース、API別設定対応）
  - ✅ セキュリティヘッダー設定（CSP, HSTS, X-Frame-Options等）
  - _要件: 10.2, 10.5, 10.6_

## フェーズ3: 基本アイテム管理CRUD

- [x] 5. アイテム管理API実装
  - ✅ GET /api/items（一覧取得）の実装
  - ✅ POST /api/items（新規作成）の実装
  - ✅ PUT /api/items/[id]（更新）の実装
  - ✅ DELETE /api/items/[id]（削除）の実装
  - ✅ Zodバリデーションとエラーハンドリング
  - ✅ ページネーション、ソート、フィルタリング機能
  - ✅ ユーザーID不整合問題修正（認証システム改善）
  - _要件: 1.1, 1.2, 1.4, 1.5_

- [x] 6. アイテム検索・フィルタリング機能
  - ✅ 検索クエリパラメータ処理（名前、カテゴリ、説明での部分一致）
  - ✅ Prismaクエリ最適化とインデックス設計
  - ✅ ページネーション機能実装
  - ✅ ソート機能実装（作成日、更新日、名前順）
  - ✅ 詳細検索テストUI実装
  - _要件: 1.3_

- [ ] 7. バリデーションとエラーハンドリング
  - アイテム作成・更新時のZodバリデーション
  - 必須項目チェックとエラーメッセージ
  - APIエラーレスポンス統一化
  - クライアントサイドエラー表示
  - _要件: 1.6_

## フェーズ4: フォルダ分類システム

- [ ] 8. フォルダ管理API実装
  - POST /api/folders（フォルダ作成）の実装
  - GET /api/folders（フォルダ一覧）の実装
  - PUT /api/folders/[id]（フォルダ更新）の実装
  - DELETE /api/folders/[id]（フォルダ削除、アイテム移動処理）の実装
  - _要件: 2.1, 2.4_

- [ ] 9. フォルダ階層機能実装
  - 3階層までのネストフォルダ作成機能
  - 階層構造の表示とナビゲーション
  - フォルダ移動時の循環参照チェック
  - 階層深度制限のバリデーション
  - _要件: 2.5_

- [ ] 10. アイテム・フォルダ関連機能
  - アイテムのフォルダ移動機能（ドラッグ&ドロップ対応準備）
  - フォルダ内アイテム一覧表示
  - フォルダ名重複チェック機能
  - 未分類アイテム管理
  - _要件: 2.2, 2.3, 2.6_

## フェーズ5: 画像管理システム

- [ ] 11. ファイルアップロード基盤
  - POST /api/upload エンドポイント実装
  - ファイル形式検証（JPG、PNG、WEBP）
  - ファイルサイズ制限（10MB）チェック
  - ローカルファイルストレージ（uploads/フォルダ）設定
  - _要件: 3.1, 3.6_

- [ ] 12. 画像管理機能実装
  - ItemImageモデルとの連携実装
  - 1アイテムあたり最大10枚の画像制限
  - 画像の順序変更機能（ドラッグ&ドロップ対応準備）
  - 画像削除機能と確認ダイアログ
  - _要件: 3.2, 3.4, 3.5_

- [ ] 13. 画像表示最適化
  - サムネイル生成機能（Sharp使用）
  - 遅延読み込み（Lazy Loading）実装
  - フルサイズ画像モーダル表示
  - レスポンシブ画像表示
  - _要件: 3.3, 9.4_

## フェーズ6: フロントエンドUI実装

- [ ] 14. 基本レイアウトとナビゲーション
  - src/app/layout.tsx メインレイアウト作成
  - ヘッダー、サイドバー、フッターコンポーネント
  - レスポンシブナビゲーションメニュー
  - ログイン/ログアウトUI
  - _要件: 9.1, 9.2_

- [ ] 15. アイテム一覧・詳細表示UI
  - アイテムカードコンポーネント作成
  - グリッドレイアウト（1列・2列・3列対応）
  - アイテム詳細モーダルまたは個別ページ
  - 検索バーとフィルター UI
  - _要件: 1.2, 1.3_

- [ ] 16. アイテム作成・編集フォーム
  - アイテム作成フォームコンポーネント
  - アイテム編集フォームコンポーネント
  - リアルタイムバリデーション表示
  - フォーム送信時のローディング状態
  - _要件: 1.1, 1.4, 1.6_

- [ ] 17. フォルダ管理UI実装
  - フォルダツリー表示コンポーネント
  - フォルダ作成・編集モーダル
  - フォルダ内アイテム一覧表示
  - パンくずナビゲーション
  - _要件: 2.1, 2.3, 2.5_

## フェーズ7: AI機能基盤（将来対応）

- [ ] 18. AI機能API基盤準備
  - POST /api/ai/recognize エンドポイント作成（モック実装）
  - Vertex AI クライアント設定準備
  - AI機能利用制限チェック機能
  - AI処理ステータス管理
  - _要件: 4.1, 7.1_

- [ ] 19. AI商品名認識UI実装
  - 画像アップロード時のAI認識トリガー
  - AI認識結果の表示UI（3つまでの提案）
  - 信頼度スコア表示
  - 商品名提案の採用・拒否機能
  - _要件: 4.2, 4.4, 4.5, 4.6_

- [ ] 20. AI価格比較機能準備
  - POST /api/ai/search-prices エンドポイント（モック実装）
  - 価格検索結果表示UI
  - 価格履歴保存機能
  - 外部サイトリンク表示
  - _要件: 5.1, 5.2, 5.3, 5.5_

## フェーズ8: ユーザー管理機能

- [ ] 21. ユーザープロフィール管理
  - ユーザープロフィール表示・編集ページ
  - パスワードリセット機能
  - アカウント削除機能（確認手続き付き）
  - メール認証機能
  - _要件: 8.3, 8.5_

- [ ] 22. データエクスポート機能
  - ユーザーデータのCSVエクスポート機能
  - アイテム・フォルダ・画像データの一括出力
  - エクスポートファイル生成とダウンロード
  - プライバシー保護（画像URLの処理）
  - _要件: 8.4_

- [ ] 23. フリーミアム機能制限実装
  - AI機能利用回数制限チェック
  - 利用状況ダッシュボード表示
  - 有料プランアップグレードUI
  - 制限超過時のメッセージ表示
  - _要件: 7.1, 7.2, 7.4_

## フェーズ9: パフォーマンス・最適化

- [ ] 24. フロントエンド最適化
  - React.memoとuseMemoによる再レンダリング最適化
  - 仮想スクロール実装（大量アイテム対応）
  - 画像の遅延読み込みとプリロード
  - コードスプリッティングとChunk最適化
  - _要件: 9.3, 9.4_

- [ ] 25. オフライン対応とPWA機能
  - Service Worker実装
  - オフライン時の基本閲覧機能
  - キャッシュ戦略実装
  - ネットワーク状態表示とエラーハンドリング
  - _要件: 9.5, 9.6_

- [ ] 26. データベース最適化
  - 適切なインデックス設計と作成
  - N+1クエリ問題の解決
  - データベース接続プーリング設定
  - 不要データのクリーンアップスクリプト
  - _要件: 9.3, 10.1_

## フェーズ10: テスト・品質保証

- [ ] 27. ユニットテスト実装
  - API エンドポイントのテスト（Jest + Supertest）
  - Reactコンポーネントのテスト（Testing Library）
  - ビジネスロジックの単体テスト
  - バリデーション機能のテスト
  - _要件: 全要件のテストカバレッジ_

- [ ] 28. 統合・E2Eテスト
  - 主要ユーザーフローのE2Eテスト（Playwright）
  - データベース統合テスト
  - 認証フローのテスト
  - ファイルアップロード機能のテスト
  - _要件: 全要件の統合テスト_

- [ ] 29. デプロイメント・本番環境設定
  - Vercel本番環境設定
  - 環境変数とシークレット管理
  - PostgreSQL本番データベース設定
  - モニタリングとログ設定
  - _要件: 10.2, 10.5_

---

## 実装メモ・学んだこと

### フェーズ2: 認証システムとセキュリティで学んだこと

#### NextAuth.js認証システム構築での学び
- **NextAuth.js v5 (Auth.js) 移行の課題**: v4からv5への移行時、Prisma Adapterとの互換性問題が発生
- **解決策**: ハイブリッド方式を採用（JWT戦略 + signInコールバックでの手動DB保存）
- **環境変数**: v5では`AUTH_SECRET`が必要、`NEXTAUTH_*`は不要
- **ミドルウェア**: v5では`auth()`関数をラップする形式に変更
- **安定性**: Prisma Adapterを使用せず、手動でユーザー情報をDB保存する方が安定
- **セッション管理**: JWT戦略でも十分、データベース戦略は設定が複雑

#### セキュリティ機能実装での学び
- **セキュリティヘッダー**: CSP（Content Security Policy）の設定でGoogle OAuth用のドメインを許可する必要がある
- **レート制限**: メモリベースの実装は開発には十分だが、本番環境ではRedis推奨
- **Zodバリデーション**: 再利用可能なスキーマとエラーハンドリングユーティリティで開発効率向上
- **型安全性**: ZodスキーマからTypeScript型を自動生成することで型の一貫性を保持

### フェーズ3: 基本アイテム管理CRUDで学んだこと

#### アイテム管理API実装での学び
- **Edge Runtime問題**: PrismaクライアントはEdge Runtimeで動作しないため、`export const runtime = 'nodejs'`が必要
- **ユーザーID不整合問題**: NextAuth.jsのデフォルト設定では再ログイン時にユーザーIDが変わる問題が発生
- **解決策**: メールアドレスをベースにした一貫性のあるユーザーID管理を実装
- **データベースリセット**: 認証システム変更時は既存データとの互換性確保のためDBリセットが必要
- **認証チェック**: APIルートでは`session.user.email`を確認し、`ensureUserExists`でユーザー存在を保証

#### アイテム検索・フィルタリング機能実装での学び
- **SQLite制限事項**: `mode: "insensitive"`はPostgreSQL専用でSQLiteでは使用不可
- **SQLite検索対応**: 検索クエリをlowerCase()で正規化してContains検索を実行
- **インデックス最適化**: ユーザーID、名前、カテゴリ等の複合インデックスで検索パフォーマンス向上
- **検索テストUI**: 詳細検索機能のテスト用UIを`/test/items/search`に実装

## 次回実装開始に向けての伝達事項（2025-07-24時点）

### 現在の実装状況
- **完了**: フェーズ3タスク5「アイテム管理API実装」まで完了
- **次のタスク**: フェーズ3タスク6「アイテム検索・フィルタリング機能」
- **動作確認済み**: CRUD API全機能、認証システム、セキュリティ機能

### 実装済みの主要コンポーネント

#### 認証・セキュリティ基盤
- `src/lib/auth.ts`: NextAuth.js v5設定（メールベースユーザーID管理）
- `src/lib/security.ts`: セキュリティヘッダー、HTTPS強制
- `src/lib/rate-limit.ts`: レート制限（メモリベース）
- `src/lib/user-helper.ts`: ユーザー存在確認・作成ヘルパー

#### API実装
- `src/app/api/items/route.ts`: アイテム一覧取得・作成
- `src/app/api/items/[id]/route.ts`: アイテム詳細・更新・削除
- `src/app/api/test/`: デバッグ用APIエンドポイント

#### バリデーション
- `src/lib/validations/`: Zodスキーマ（item, user, folder, upload）
- 統一されたエラーレスポンス形式

#### テスト環境
- `src/app/test/items/`: アイテム管理テストUI
- `src/app/debug/`: システムデバッグページ
- ホームページからのナビゲーションリンク

### 次回実装時の注意点

#### 技術的な重要事項
1. **Runtime設定**: 全APIルートで`export const runtime = 'nodejs'`が必要
2. **認証パターン**: `ensureUserExists`を使用してユーザー存在を保証
3. **Decimal型**: Prismaの価格フィールドは`decimal.js`ライブラリを使用
4. **データベース**: 既存データとの互換性を維持（リセットしない）

#### 実装方針
1. **既存パターンを踏襲**: 認証チェック、エラーハンドリング、バリデーションパターンを統一
2. **テスト駆動**: 実装後は必ずテストUIでの動作確認を実施
3. **ログ記録**: 重要な処理では適切なコンソールログを出力
4. **型安全性**: ZodスキーマとTypeScript型の一貫性を保持

#### 推奨する実装順序（フェーズ3続き）
1. **タスク6**: アイテム検索・フィルタリング機能
   - 既存のGET /api/itemsに実装済みの検索機能を活用
   - Prismaクエリ最適化とインデックス設計
   
2. **タスク7**: バリデーションとエラーハンドリング
   - 既存のZodバリデーションを拡張
   - フロントエンド側のエラー表示改善

### 環境・設定情報
- **データベース**: SQLite（`/home/ryauchi/work/repository/plat-dot/prisma/dev.db`）
- **認証プロバイダー**: Google OAuth（環境変数設定済み）
- **ポート**: 3000（開発サーバー）
- **Git**: mainブランチで作業中

### トラブルシューティング
- ユーザーID問題が再発した場合: `src/lib/auth.ts`の設定確認
- Edge Runtimeエラー: APIルートに`runtime = 'nodejs'`追加
- 認証エラー: `ensureUserExists`ヘルパーの使用確認

---

## タスク実装ガイドライン

### 完了条件
- 各タスクは2-4時間で完了可能なサイズに設計
- 実装完了後は該当する要件の受入条件をすべて満たす
- ユニットテストまたは手動テストで動作確認済み
- コードレビューとドキュメント更新完了

### 依存関係
- フェーズ1-2は並行実行可能
- フェーズ3はフェーズ1-2完了後
- フェーズ4-6は並行実行可能（フェーズ3完了後）
- フェーズ7は独立実装可能（モック使用）
- フェーズ8-10は他フェーズ完了後

### 技術スタック確認
- Next.js 14.x App Router使用
- TypeScript厳密モード有効
- Prisma ORM + SQLite（開発）/ PostgreSQL（本番）
- NextAuth.js + Google OAuth
- Tailwind CSS + shadcn/ui（将来）
- Zod バリデーション